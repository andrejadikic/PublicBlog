<!DOCTYPE html>
<html>
<head>
    <title>Hello World</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
          integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
</head>
<body>

<div id="container" class="container">
    <h1 class="title">Posts</h1>
    <br>

    <div id ="newPost">
        <form method="POST" id="subject-form">
            <div class="form-group">
                <label for="author">Author</label>
                <input type="text" class="form-control" id="author" placeholder="Enter author">

                <label for="title">Title</label>
                <input type="text" class="form-control" id="title" placeholder="Enter title">

                <label for="content">Content</label>
                <textarea class="form-control" id="content"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Submit</button>
        </form>
    </div>

    <div id="allPosts">
        <div id="posts-links">
        </div>
        <br>
        <button onclick="addPostForm()" >New Post</button>
    </div>
</div>

<script>
    const posts = document.getElementById('allPosts');
    fetch('/api/posts', {
        method: 'GET'
    }).then(response => {
        return response.json();
    }).then(posts => {
        for (const post of posts) {
            addPost(post)
        }
    })
    const newPost = document.getElementById('newPost');
    newPost.hidden=true;
    function addPostForm(){
        posts.hidden = true;
        newPost.hidden = false;
    }


    function addPost(post) {
        const postLinks = document.getElementById('posts-links');

        const linkWrapperDiv = document.createElement('div');
        const postTitle = document.createElement('h2');
        postTitle.innerText = post.title;

        const postContent = document.createElement('p');
        postContent.innerText = post.content;

        postContent.style.height='4em';
        postContent.style.overflow = 'hidden';
        postContent.style.textOverflow = 'ellipsis';

        const postElement = document.createElement('div');
        postElement.appendChild(postContent);


        const detailsBtn = document.createElement('button');
        detailsBtn.innerText = 'Details'
        detailsBtn.onclick = function (e) {
            posts.hidden = true;
            const detailsDiv = document.createElement('div');
            const postTitle = document.createElement('h1');
            postTitle.innerText = post.title;

            const postAuthor = document.createElement('p');
            postAuthor.innerText = post.author;

            const postContent = document.createElement('p');
            postContent.innerText = post.content;

            detailsDiv.appendChild(postTitle);
            detailsDiv.appendChild(postAuthor);
            detailsDiv.appendChild(postContent);

            const commentsDiv = document.createElement('div');
            const postComments = document.createElement('h2');
            postComments.innerText = "Comments";
            commentsDiv.appendChild(postComments);
            fetch('/api/comments', {
                method: 'GET'
            }).then(response => {
                return response.json();
            }).then(posts => {
                for (const comment of posts) {
                    const nameComm = document.createElement('h3');
                    nameComm.innerText = comment.name;
                    const textComm = document.createElement('p');
                    textComm.innerText = comment.comment;
                }
            })

        }

        // subjectLink.hidden = true;
        linkWrapperDiv.appendChild(postTitle);
        linkWrapperDiv.appendChild(document.createElement('br'));
        linkWrapperDiv.appendChild(postElement);
        linkWrapperDiv.appendChild(detailsBtn);

        postLinks.appendChild(linkWrapperDiv);
    }

    function deleteSubject(id) {
        return fetch('/api/posts/'+id, {
            method: 'DELETE'
        })
    }

    document.getElementById("subject-form").addEventListener('submit', function(e) {
        e.preventDefault();

        const authorElement = document.getElementById('author');
        const titleElement = document.getElementById('title');
        const contentElement = document.getElementById('content');

        const title = titleElement.value;
        const content = contentElement.value;
        const author = authorElement.value;

        fetch('/api/posts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                author: author,
                title: title,
                content: content
            })
        }).then(response => {
            return response.json();
        }).then(post => {
            addPost(post)
            authorElement.value = '';
            titleElement.value = '';
            contentElement.value = '';
            newPost.hidden=true;
            posts.hidden=false;
        })
    })
</script>
</body>
</html>

